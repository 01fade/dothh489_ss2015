<!DOCTYPE html>
<html>
<head>
    <title>Test Video</title>
    <!-- Author _ Hang Do Thi Duc ( 22-8miles.com ) -->
    <!-- Code Base _ https://github.com/josdirksen/learning-threejs - Example 10.11 - Video texture-->
    <!-- libaries -->
    <script type="text/javascript" src="js/libs/three.min.js"></script>
    <script type="text/javascript" src="js/libs/jquery.min.js"></script>
    <!-- post processing required-->
    <script type="text/javascript" src="js/postprocessing_required/CopyShader.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/EffectComposer.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/RenderPass.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/MaskPass.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/ShaderPass.js"></script>
    <!-- post processing shaders -->
    <script src="js/postprocessing_shaders/DotScreenShader.js"></script>
    <script src="js/postprocessing_shaders/RGBShiftShader.js"></script>
    <script src="js/postprocessing_shaders/pattern2.js"></script>
    <script src="js/postprocessing_shaders/Vignette.js"></script>
    <!-- stats, gui -->
    <script type="text/javascript" src="js/libs/stats.min.js"></script>
    <script type="text/javascript" src="js/libs/dat.gui.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000;}
        #WebGL-output canvas{ position: absolute; top:0; left:0; bottom:0; right:0; margin: auto;}
        #Stats-output { position: absolute; z-index: 100; top:0; left:0;}
    </style>
</head>
<body>
<div id="Stats-output"></div>
<div id="WebGL-output"></div>
<script type="text/javascript">
    var camera, scene, renderer;
    var video, texture, videoMaterial;
    var composer;
    var shaderTime = 0;
    var pattern1Params, rgbParams;

    var rgbPass, rectanglePass, renderPass, copyPass;
    var gui, controls, stats;

    init();
    animate();

    function init(){
        scene = new THREE.Scene();
        camera  = new THREE.OrthographicCamera(window.innerWidth / - 2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / - 2, -10000, 10000 )
        camera.position.z = 3;
        renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(new THREE.Color(0x000000, 1.0));
        $("#WebGL-output").append(renderer.domElement);

        video = document.createElement('video');
        video.loop  = true;
        video.volume    = 0.01;
        video.src   = "assets/vcr.mp4";
        video.play();

        texture = new THREE.Texture(video);
        texture.minFilter = THREE.LinearFilter;
        texture.magFilter = THREE.LinearFilter;
        texture.format = THREE.RGBFormat;
        texture.generateMipmaps = false;

        var geometry    = new THREE.PlaneGeometry(window.innerWidth, window.innerWidth * 9/16);
        var material    = new THREE.MeshBasicMaterial({ map : texture });
        var mesh = new THREE.Mesh( geometry, material );
        scene.add(mesh);

        //Create Shader Passes
        renderPass = new THREE.RenderPass( scene, camera );
        rectanglePass = THREE.ShaderPass( THREE.Vignette );
        rgbPass = new THREE.ShaderPass( THREE.RGBShiftShader );
        copyPass = new THREE.ShaderPass( THREE.CopyShader );

        //Init GUI controls
        controls = new function () {
            this.pauuse = function(){video.pause();};
            this.plaay = function(){video.play();};
            this.show1 = false;
            this.linesScale = 200;
            this.rgbamount = 0.005;
        };

        pattern1Params = { show: true, linesScale: 200 };
        rgbParams = { show: true, amount: 0.005 };


        gui = new dat.GUI();
        // gui.add(controls, "pauuse").name("Pause Video");
        // gui.add(controls, "plaay").name("Play Video");

        var f1 = gui.addFolder('1 - Lines');
        f1.add(pattern1Params, "show", false).name("Show").listen().onChange(onToggleShaders);
        f1.add(pattern1Params, "linesScale",150 ,250).step(10).name("Amount").listen().onChange(onParamsChange);
        f1.open();
        var f2 = gui.addFolder('RGB Shift');
        f2.add(rgbParams, "show", false).name("Show").listen().onChange(onToggleShaders);
        f2.add(rgbParams, "amount",0.0 ,0.01).name("Amount").listen().onChange(onParamsChange);
        f2.open();
        gui.close();

        onToggleShaders();
        onParamsChange();

        window.addEventListener( 'resize', onWindowResize, false );
        onWindowResize();

        stats = new Stats();
        stats.setMode(0); // 0: fps, 1: ms
        $("#Stats-output").append(stats.domElement);
    }; // init end

    function onWindowResize(e) {
        renderer.setSize(window.innerWidth, window.innerWidth * 9/16);
    }

    function onToggleShaders(){

        console.log("hello");

        //Add Shader Passes to Composer
        //order is important
        composer = new THREE.EffectComposer( renderer);
        composer.addPass( renderPass );

        if (pattern1Params.show == true){
            composer.addPass( rectanglePass );
        }

        rgbPass.renderToScreen = true;
        // if (rgbParams.show == true){
            composer.addPass( rgbPass );
        // }

        // copyPass.renderToScreen = true;
        // composer.addPass( copyPass );
    }


    function onParamsChange() {
        rgbPass.uniforms[ "angle" ].value = 20.0*Math.PI;
        rgbPass.uniforms[ "amount" ].value = rgbParams.amount;

        // rectanglePass.uniforms[ "scale" ].value = controls.linesScale;
        // console.log(rectanglePass);
    }

    function animate() {
        shaderTime += 0.1;
        // rectanglePass.uniforms[ 'time' ].value =  shaderTime;

        if ( video.readyState === video.HAVE_ENOUGH_DATA ) {
            if ( texture ) texture.needsUpdate = true;
        }

        requestAnimationFrame( animate );
        composer.render( camera, scene);
        stats.update();
    }

</script>
</body>
</html>



