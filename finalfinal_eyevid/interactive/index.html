<!DOCTYPE html>
<html>
<head>
    <title>Shaders + The xx (VCR)</title>
    <!-- Author _ Hang Do Thi Duc ( 22-8miles.com ) -->
    <!-- Code Base _ https://github.com/josdirksen/learning-threejs - Example 10.11 - Video texture-->
    <!-- libaries -->
    <script type="text/javascript" src="js/libs/three.min.js"></script>
    <script type="text/javascript" src="js/libs/jquery.min.js"></script>
    <!-- post processing required-->
    <script type="text/javascript" src="js/postprocessing_required/CopyShader.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/EffectComposer.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/RenderPass.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/MaskPass.js"></script>
    <script type="text/javascript" src="js/postprocessing_required/ShaderPass.js"></script>
    <!-- post processing shaders -->
    <script src="js/postprocessing_shaders/DotScreenShader.js"></script>
    <script src="js/postprocessing_shaders/RGBShiftShader.js"></script>
    <script src="js/postprocessing_shaders/pattern1a.js"></script>
    <!-- stats, gui -->
    <script type="text/javascript" src="js/libs/stats.min.js"></script>
    <script type="text/javascript" src="js/libs/dat.gui.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000;}
        #WebGL-output canvas{ position: absolute; top:0; left:0; bottom:0; right:0; margin: auto;}
        #Stats-output { position: absolute; z-index: 100; top:0; left:0;}
    </style>
</head>
<body>
<div id="Stats-output"></div>
<div id="WebGL-output"></div>
<script type="text/javascript">
    var camera, scene, renderer;
    var video, texture, videoMaterial;
    var composer;
    var mouse = {"x": 0, "y": 0};
    var shaderTime = 0;
    var pattern1aParams, rgbParams;

    var pattern1aPass, rgbPass;
    var renderPass, copyPass;
    var gui, controls, stats;

    $(window).on("load", function() {
        init();
        animate();
        // workaround for remove pixelated video
        $(".folder:last input").trigger("click");

        $( document ).on( "mousemove", function( event ) {
          mouse.x = event.pageX/window.innerWidth;
          mouse.y = (window.innerHeight - event.pageY)/window.innerHeight;
          // console.log(mouse.x, mouse.y);
        });
    })

    function init(){
        scene = new THREE.Scene();
        camera  = new THREE.OrthographicCamera(window.innerWidth / - 2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / - 2, -10000, 10000 )
        camera.position.z = 3;
        renderer = new THREE.WebGLRenderer({antialiasing: true});
        renderer.setClearColor(new THREE.Color(0x000000, 1.0));
        $("#WebGL-output").append(renderer.domElement);

        video = document.createElement('video');
        video.loop  = false;
        video.volume    = 0.0;
        video.src   = "assets/eyevid.mp4";
        video.play();

        texture = new THREE.Texture(video);
        texture.minFilter = THREE.LinearFilter;
        texture.magFilter = THREE.LinearFilter;
        texture.format = THREE.RGBFormat;
        texture.generateMipmaps = false;

        var geometry    = new THREE.PlaneGeometry(window.innerWidth, window.innerWidth * 9/16);
        var material    = new THREE.MeshBasicMaterial({ map : texture });
        var mesh = new THREE.Mesh( geometry, material );
        scene.add(mesh);

        //Create Shader Passes
        renderPass = new THREE.RenderPass( scene, camera );
        pattern1aPass = new THREE.ShaderPass( THREE.Pattern1a );
        rgbPass = new THREE.ShaderPass( THREE.RGBShiftShader );
        copyPass = new THREE.ShaderPass( THREE.CopyShader );

        //Init GUI controls
        controls = new function () {
            this.pauuse = function(){video.pause();};
            this.plaay = function(){video.play();};
            this.speed = 0.5;
        };

        pattern1aParams = { show: false, linesScale: 16 };
        rgbParams = { show: false, amount: 0.001 };


        gui = new dat.GUI();
        gui.add(controls, "pauuse").name("Pause Video");
        gui.add(controls, "plaay").name("Play Video");

        var f1 = gui.addFolder('1a - Lines');
        f1.add(pattern1aParams, "show", true).name("Show").listen().onChange(onToggleShaders);
        f1.add(pattern1aParams, "linesScale",10 ,20).step(0.5).name("Amount").listen().onChange(onParamsChange);
        f1.open();

        var f11 = gui.addFolder('RGB Shift (Three.js)');
        f11.add(rgbParams, "show", true).name("Show").listen().onChange(onToggleShaders);
        f11.add(rgbParams, "amount",0.0 ,0.01).name("Amount").listen().onChange(onParamsChange);
        // f11.open();

        gui.add(controls, "speed", 0, 2).name("Speed");
        gui.close();

        onToggleShaders();
        onParamsChange();
        // once init mouse uniforms type
        pattern1aPass.uniforms[ "mouse" ].type = "v2";

        window.addEventListener( 'resize', onWindowResize, false );
        onWindowResize();

        stats = new Stats();
        stats.setMode(0); // 0: fps, 1: ms
        $("#Stats-output").append(stats.domElement);
    }; // init end

    function onWindowResize(e) {
        renderer.setSize(window.innerWidth, window.innerWidth * 9/16);
    }

    function onToggleShaders(){
        //Add Shader Passes to Composer
        composer = new THREE.EffectComposer( renderer);
        composer.addPass( renderPass );

        if (pattern1aParams.show == true){
            composer.addPass( pattern1aPass );
        }
        if (rgbParams.show == true){
            composer.addPass( rgbPass );
        }
        copyPass.renderToScreen = true;
        composer.addPass( copyPass );
    }


    function onParamsChange() {
        rgbPass.uniforms[ "angle" ].value = 20.0*Math.PI;
        rgbPass.uniforms[ "amount" ].value = rgbParams.amount;

        pattern1aPass.uniforms[ "scale" ].value = pattern1aParams.linesScale;
    }

    function animate() {
        shaderTime += 0.05 * controls.speed;
        pattern1aPass.uniforms[ 'time' ].value =  shaderTime;
        pattern1aPass.uniforms[ "mouse" ].value = new THREE.Vector2( mouse.x, mouse.y );


        if ( video.readyState === video.HAVE_ENOUGH_DATA ) {
            if ( texture ) texture.needsUpdate = true;
        }

        requestAnimationFrame( animate );
        composer.render( camera, scene);
        stats.update();
    }

</script>
</body>
</html>



